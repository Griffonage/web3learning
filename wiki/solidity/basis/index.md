---
title: 合约基础
sidebar_label: 🧐合约基础
sidebar_position: 20
image: /img/bac111.png
description: aaa
---
import {EmbedGiscus} from '@site/src/components/Talk'

![](assets/bac-info3.png)

整篇教程尽量以简短的形式帮助大家掌握一些核心的概念，会先梳理出开发时需要用到的一些只是体系以及较为详细的内容

合约的开发主要构成为：调用者、执行方法、可能有的日志记录监听
可以做个类比，智能合约与后端的区别（这里使用后端的概念较为好理解），

DApp至少由以下部分组成：

- 区块链上的智能合约
- 一个Web前端用户界面

### 钱包

钱包是你通往区块链系统的门户。它拥有你的密钥，并且可以代表你创建和广播交易。
选择一个以太坊钱包可能很困难，因为有很多不同功能和设计选择。
有些更适合初学者，有些更适合专家。即使你现在选择一个你喜欢的，你可能会决定稍后切换到另一个钱包。
以太坊本身在不断变化，“最好”的钱包往往是适应它们的。
别担心！如果你选择一个钱包而不喜欢它的工作方式，那么你可以很容易地更换钱包。
你只需进行一项交易，即将资金从旧钱包发送到新钱包，或者通过导出和导入私钥来移动密钥。

狭义上讲，从程序员的角度来看，“钱包”一词是指用于存储和管理用户密钥的系统。
每个“钱包”都有一个密钥管理组件。对于一些钱包来说，这就是全部。
其他一些钱包是更广泛类别的一部分，即“浏览器”，它是以太坊去中心化应用或“DApps”的接口。
在“钱包”这个术语下混合的各种类别之间没有明确的区别。

#### 广义上的钱包

功能：

- 控制对用户资金的访问
- 管理密钥和地址
- 追踪余额查看上链的记录
- 以及创建和签署交易
- 连接前端程序操作DAPP、合约

#### 程序员需要了解的定义

狭义上讲，从程序员的角度来看，“钱包”一词是指用于存储和管理用户密钥的系统。
每个“钱包”都有一个密钥管理组件。对于一些钱包来说，这就是全部。
其他一些钱包是更广泛类别的一部分，即“浏览器”，它是以太坊去中心化应用或“DApps”的接口。
在“钱包”这个术语下混合的各种类别之间没有明确的区别。

钱包技术移步：[钱包技术讲解](https://github.com/inoutcode/ethereum_book/blob/master/%E7%AC%AC%E5%85%AD%E7%AB%A0.asciidoc)

### 密钥与地址（账户）

以太坊的基础技术之一是 密码学 cryptography，它是数学的一个分支，广泛用于计算机安全。
密码学在希腊文中的意思是“秘密写作”，但密码学的科学不仅仅包含秘密协作，它被称为加密。
加密也可以用来证明秘密的知识而不泄露该秘密（数字签名），或者证明数据的真实性（数字指纹）。
这些类型的密码学证明是以太坊和大多数区块链系统的关键数学工具，广泛用于以太坊应用。
讽刺的是，加密并不是以太坊的重要组成部分，因为它的通信和交易数据没有加密，也不需要加密以保护系统。

以太坊交易需要将有效的数字签名包含在区块链中，该签名只能使用密钥生成；
因此，任何拥有该密钥副本的人都可以控制ether。以太坊交易中的数字签名证明了资金的真正所有者。

**私钥**只是一个随机选取的数字。私有密钥的所有权和控制权是用户控制与相应以太坊地址相关联的所有资金的基础，也是对该地址的合同的访问权授权。通过证明交易中使用的资金的所有权，私钥用于创建花费ether所需的签名。私钥在任何时候都必须保密，因为向第三方透露密钥相当于让他们控制以太和由该密钥保证的合同。私钥还必须备份并防止意外丢失。如果它丢失了，无法恢复，它保护的资金也将永远丢失。

:::info
以太坊私钥只是一个数字。你可以使用硬币，铅笔和纸随机挑选你的私钥：投掷硬币256次，得到可以在以太坊钱包中使用的随机二进制数字作为私钥。然后可以从私钥生成公钥和地址。
:::

**公钥**是两个数字，并联在一起。这些数字是通过一次单向的计算从私钥生成的。这意味着，如果你拥有私钥，则计算公钥是微不足道的。但是你不能从公钥中计算私钥。

:::info
椭圆曲线乘法是密码学家称之为“单向”函数的一种函数：在一个方向（乘法）很容易完成，而在相反方向（除法）不可能完成。私钥的所有者可以很容易地创建公钥，然后与世界共享，因为知道没有人能够反转该函数并从公钥计算私钥。这种数学技巧成为证明以太坊资金所有权和合同控制权的不可伪造和安全数字签名的基础。
:::

**地址**是十六进制数字，从公钥的Keccak-256哈希的最后20个字节导出的标识符。
与在所有客户端的用户界面中编码的比特币地址不同，它们包含内置校验和来防止输入错误的地址，以太坊地址以原始十六进制形式呈现，没有任何校验和。

:::info 密码学相关数学函数
- [密码](https://en.wikipedia.org/wiki/Cryptography)
- [Trapdoor函数](https://en.wikipedia.org/wiki/Trapdoor_function)
- [素因子分解](https://en.wikipedia.org/wiki/Integer_factorization)
- [离散对数](https://en.wikipedia.org/wiki/Discrete_logarithm)
- [椭圆曲线密码学](https://en.wikipedia.org/wiki/Elliptic_curve_cryptography)
:::
  私钥技术移步：[私钥技术讲解](https://github.com/inoutcode/ethereum_book/blob/master/%E7%AC%AC%E4%BA%94%E7%AB%A0.asciidoc)


### 交易
交易是由外部所有帐户发起的签名消息，由以太坊网络传输，并在以太坊区块链上进行记录（挖掘）。
在这个基本定义背后，有很多令人惊讶和着迷的细节。
看待交易的另一种方式是，它们是唯一可触发状态更改或导致合约在EVM中执行的东西。
以太坊是一个全球的单实例状态机器，交易是唯一可以让状态机“运动”，改变状态的东西。合约不会自行运行。
以太坊不会在后台运行。一切都始于交易。

交易移步：[交易讲解](https://github.com/inoutcode/ethereum_book/blob/master/%E7%AC%AC%E4%B8%83%E7%AB%A0.asciidoc)

目前的以太坊使用工作量证明（POW）的方式对交易进行验证、打包、广播，可以简单的理解为挖矿，当账户发起交易，需要支付一定的gas手续费，
矿工对此交易进行验证、打包、广播，然后收取此交易的手续费

### 合约

术语_smart contract_已被用于描述各种不同的事物。
在二十世纪九十年代，密码学家Nick Szabo提出了这个术语，并将其定义为“一组以数字形式规定的承诺，包括各方在其他承诺中履行的协议”。
自那时以来，智能合约的概念得到了发展，尤其是在2009年比特币发明引入了去中心化区块链之后。
让我们拆解这个定义：
计算机程序：智能合约只是计算机程序。合约这个词在这方面没有法律意义。
不可变的：一旦部署，智能合约的代码不能改变。与传统软件不同，修改智能合约的唯一方法是部署新实例。 
确定性的：智能合约的结果对于运行它的每个人来说都是一样的，包括调用它们的交易的上下文，
以及执行时以太坊区块链的状态。 EVM上下文：智能合约以非常有限的执行上下文运行。
他们可以访问自己的状态，调用它们的交易的上下文以及有关最新块的一些信息。 
去中心化的世界计算机：EVM在每个以太坊节点上作为本地实例运行，
但由于EVM的所有实例都在相同的初始状态下运行并产生相同的最终状态，因此整个系统作为单台世界计算机运行。

### 货币单位

以太坊的货币单位称为 以太 ether，也被称为ETH或符号 Ξ （来自看起来像程式化的大写字母E的希腊字母“Xi”）或（不太常见的）♦，例如，1个以太，或1个ETH，或 Ξ1，或 ♦1

:::info
Tip
Ξ 使用Unicode字符926，♦使用9830。
:::
以太被细分为更小的单位，直到可能的最小单位，这被命名为_wei_。一个 ether 是 1× 10^18 或1,000,000,000,000,000,000 个
wei。你可能会听到人们也提到货币“以太坊”，但这是一个常见的初学者的错误。以太坊是制度，以太是货币。
以太的值总是在以太坊内部表示为_wei_，无符号整数值。当你处理1个以太网时，交易将编码10000000000000000000 wei作为值。
以太的各种单位既有使用国际单位系统（SI）的科学名称，也有口语化的名字，向计算机和密码学的许多伟大思想致敬。

| Value (in wei)| 指数             | 通用名称 | SI 名称 |
| ------------- |----------------| --------------- | ---------------------------------- |
| Value (in wei) | Exponent       | Common Name | SI Name
| 1 | 1              | wei | wei
| 1,000 | 10<sup>3</sup> | babbage | kilowei or femtoether
| 1,000,000 | 10<sup>6</sup>       | lovelace | megawei or picoether
| 1,000,000,000 | 10<sup>9</sup>       | shannon | gigawei or nanoether
| 1,000,000,000,000 | 10<sup>12</sup>      | szabo | microether or micro
| 1,000,000,000,000,000 | 10<sup>15</sup>      | finney | milliether or milli
| _1,000,000,000,000,000,000_ | _10<sup>18</sup>_    | _ether_ | _ether_
| 1,000,000,000,000,000,000,000 | 10<sup>21</sup>      | grand | kiloether
| 1,000,000,000,000,000,000,000,000 | 10<sup>24</sup>      | | megaether

### Gas

Gas是以太坊用于衡量程序执行一个或一组动作所需计算量的单位。交易或合约执行的每项操作都需要一定数量的gas;
所需的gas数量与正在执行的计算步骤的类型和数量有关。与仅以千字节（kB）计算交易规模的比特币交易费相比，
以太坊交易费必须考虑智能合约代码可以执行的任意数量的计算步骤。
程序执行的操作数越多，运行完成的成本就越高。

每次操作都需要固定量的gas。以太坊黄皮书的的一些例子：

添加两个数字需要3个gas

计算Keccak256哈希值，需要30个gas+ 每256位数据被哈希6个gas

发送交易成本为21000 gas

gas是以太坊的重要组成部分，具有双重作用。
- 作为以太坊价格（具有波动性）和矿工对其工作的奖励之间的抽象层。
- 另一种是抵御拒绝服务攻击。
- 为了防止网络中的意外或恶意无限循环或其他计算浪费，每个交易的发起者需要设置他们愿意花费在gas上的金额的限制。

因此，gas系统阻止攻击者发送垃圾邮件交易，因为他们必须按比例支付他们消耗的计算，带宽和存储资源。

支付gas
虽然gas有价格，但它不能“拥有”也不能“花”。
gas仅存在于以太坊虚拟机（EVM）内部，作为计算工作量的计数。
发起方被收取ether交易费，然后转换为gas，然后转回到ether，作为矿工的块奖励。
这些转换步骤用于将计算的价格（与“工作量”相关）与ether的价格（与市场波动相关）分开。

#### gas成本限制和gas耗尽
在发送交易之前，发起方必须指定gas limit - 他们愿意购买的最大gas数量。他们还必须指定gas price - 他们愿意为每单位gas支付的以太价格。

以ether计算的`gas limit * gas price`在交易执行开始时从发起方的账户中扣除作为存款。
这是为了防止发送者在执行中期“破产”并且无法支付gas费用。由于这个原因，用户也无法设置超出其帐户余额的gas限制。

理想情况下，发起方将设置一个高于或等于实际使用的gas的gas限制。
如果gas限制设置高于消耗的gas量，发货人将收到超额金额的退款，因为矿工只获得他们实际工作的补偿。

在这种情况下：
`gas限制 - 多余gas）*gas`价格以太以矿块作为块奖励
`(gas limit - excess gas) * gas price` ether作为矿工的区块奖励

`excess gas * gas price` ether退回发起方

但是，如果使用的gas超过规定的gas限制，即如果在执行期间交易“runs out of gas”，则操作终止。
虽然交易不成功，但由于矿工已经完成了计算工作，不会退回发送人的交易费用，矿工因此得到补偿。


### 开发⼯具介绍

目前主流的有 Remix 、Hardhat、 Truffle、 Ganache
- Remix主要针对于初学者，可以方便快捷的上手学习、调用、部署等
- hardhat、truffle作为常用的部署、测试框架
- Ganache作为常用的本地测试节点的搭建

相关具体的操作及使用，移步[工具库](../../tool)

### 网络及测试币

**Main Ethereum Network**
主要的，公开的以太坊区块链。真正的ETH，真正的价值，真正的后果。

一般在进行部署测试的时候，使用测试网络

**Ropsten Test Network**
以太坊公开测试区块链和网络，使用工作证明共识（挖矿）。在这个网络上的ETH没有价值。
Ropsten的问题在于攻击者铸造了数以万计的区块，产生巨大的重组并将燃气极限推到9B。当时需要一个新的公共测试网，但之后（2017年3月25日）Ropsten也复活了！
rinkeby 测试网水龙头
[Ropsten](https://faucet.metamask.io/)

**Kovan Test Network**
以太坊公开测试区块链和网络，使用“Aura”协议进行权威证明（Proof-of-Authority）共识（联合签名）。
在这个网络上的ETH没有价值。该测试网络仅由“Parity”支持。其他以太坊客户使用稍后提出的"Clique"协议作为权威证明。
[Kovan](https://gitter.im/kovan-testnet/faucet)

**Rinkeby Test Network**
以太坊公开测试区块链和网络，使用“Clique”协议进行权威证明共识（联合签名）。在这个网络上的ETH没有价值。
rinkeby 测试网水龙头
[rinkeby](https://rinkebyfaucet.com/)

**其他**
[chainlist](https://chainlist.org/) 中有较全的链列表，可以访问查看其他链的信息


<EmbedGiscus>giscusBasis</EmbedGiscus>
